<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Homepage Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f6f8;
      margin: 0;
      padding: 24px;
    }
    h1, h2, h3 { margin-top: 0; }
    button {
      padding: 6px 12px;
      margin-right: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
    button.primary {
      background: #111;
      color: #fff;
      border-color: #111;
    }
    hr { margin: 20px 0; }
    label {
      display: block;
      margin-top: 6px;
      font-size: 14px;
    }
    input, textarea, select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    textarea {
      height: 360px;
      font-family: monospace;
    }
    .hidden { display: none; }
    .box {
      background: #fff;
      border: 1px solid #ddd;
      padding: 16px;
      margin-bottom: 16px;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    #status {
      white-space: pre-wrap;
      font-size: 14px;
    }
  </style>
</head>

<body>

<!-- ===============================
     LOGIN
================================ -->
<div id="loginBox" class="box hidden">
  <h2>Admin Login</h2>
  <label>ID
    <input id="loginId" />
  </label>
  <label>Password
    <input id="loginPw" type="password" />
  </label>
  <br/>
  <button class="primary" onclick="login()">로그인</button>
  <pre id="loginStatus"></pre>
</div>

<!-- ===============================
     ADMIN
================================ -->
<div id="adminBox" class="hidden">

  <h1>Homepage Admin</h1>

  <div class="row">
    <button onclick="showTab('content')">콘텐츠</button>
    <button onclick="showTab('raw')">JSON</button>
    <button onclick="showTab('design')">디자인</button>
    <button class="primary" onclick="save()">저장</button>
    <button onclick="logout()">로그아웃</button>
  </div>

  <hr/>

  <div id="contentTab"></div>
  <div id="rawTab" class="hidden"></div>
  <div id="designTab" class="hidden"></div>

  <pre id="status"></pre>
</div>

<script>
/* ===============================
   ENV
================================ */
const API = 'https://young-sunset-d631.koolee1372.workers.dev';
let TOKEN = localStorage.getItem('ADMIN_TOKEN');
let contentData = null;
let currentTab = 'content';

/* ===============================
   INIT
================================ */
if (TOKEN) initAdmin();
else showLogin();

function showLogin() {
  loginBox.classList.remove('hidden');
}

function initAdmin() {
  loginBox.classList.add('hidden');
  adminBox.classList.remove('hidden');
  loadContent();
}

/* ===============================
   AUTH
================================ */
function login() {
  fetch(API + '/api/admin/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id: loginId.value,
      password: loginPw.value
    })
  })
  .then(r => r.ok ? r.json() : Promise.reject())
  .then(res => {
    TOKEN = res.token;
    localStorage.setItem('ADMIN_TOKEN', TOKEN);
    initAdmin();
  })
  .catch(() => loginStatus.textContent = '❌ 로그인 실패');
}

function logout() {
  localStorage.removeItem('ADMIN_TOKEN');
  location.reload();
}

/* ===============================
   TABS
================================ */
function showTab(tab) {
  currentTab = tab;
  ['contentTab','rawTab','designTab'].forEach(id =>
    document.getElementById(id).classList.add('hidden')
  );
  document.getElementById(tab + 'Tab').classList.remove('hidden');

  if (tab === 'design') loadDesign();
}

/* ===============================
   CONTENT
================================ */
function loadContent() {
  fetch(API + '/api/content')
    .then(r => r.json())
    .then(data => {
      contentData = data;
      renderContentForm();
      renderRaw();
    });
}

function renderContentForm() {
  const html = contentData.sections
    .sort((a,b)=>a.order-b.order)
    .map((s,i)=>`
      <div class="box">
        <strong>${s.id} (${s.type})</strong>
        <label>
          활성
          <input type="checkbox" ${s.enabled?'checked':''}
            onchange="contentData.sections[${i}].enabled=this.checked">
        </label>
        <label>순서
          <input type="number" value="${s.order}"
            onchange="contentData.sections[${i}].order=Number(this.value)">
        </label>
        <label>제목
          <input value="${s.content?.title||''}"
            onchange="contentData.sections[${i}].content.title=this.value">
        </label>
      </div>
    `).join('');
  contentTab.innerHTML = `<h3>콘텐츠 편집</h3>${html}`;
}

function renderRaw() {
  rawTab.innerHTML = `
    <h3>전체 JSON</h3>
    <textarea id="rawEditor">${JSON.stringify(contentData, null, 2)}</textarea>
  `;
}

/* ===============================
   DESIGN (TOKENS + VERSIONS)
================================ */
function loadDesign() {
  Promise.all([
    fetch(API + '/api/design/tokens').then(r=>r.json()),
    fetch(API + '/api/design/versions').then(r=>r.json())
  ]).then(([tokens, meta]) => {
    renderDesign(tokens, meta);
  });
}

function renderDesign(tokens, meta) {
  designTab.innerHTML = `
    <h3>디자인 토큰</h3>
    <textarea id="designEditor">${JSON.stringify(tokens, null, 2)}</textarea>
    <br/>
    <button class="primary" onclick="saveDesign()">디자인 저장</button>

    <hr/>
    <h3>버전 관리</h3>
    ${(meta.versions||[]).map(v=>`
      <div>
        <strong>${v.id}</strong> (${v.createdAt}) — ${v.memo}
        <button onclick="rollback('${v.id}')">롤백</button>
      </div>
    `).join('')}
  `;
}

function saveDesign() {
  fetch(API + '/api/design/tokens', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + TOKEN,
      'Content-Type': 'application/json'
    },
    body: designEditor.value
  })
  .then(r=>r.ok?'✅ 디자인 저장 완료':'❌ 실패')
  .then(msg=>status.textContent=msg);
}

function rollback(id) {
  if (!confirm(id + '로 되돌릴까요?')) return;
  fetch(API + '/api/design/rollback/' + id, {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + TOKEN }
  })
  .then(r=>r.ok?'✅ 롤백 완료':'❌ 실패')
  .then(msg=>status.textContent=msg);
}

/* ===============================
   SAVE CONTENT
================================ */
function save() {
  if (currentTab === 'raw') {
    try {
      contentData = JSON.parse(rawEditor.value);
    } catch {
      alert('JSON 오류');
      return;
    }
  }

  fetch(API + '/api/content', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+TOKEN
    },
    body:JSON.stringify(contentData)
  })
  .then(r=>r.ok?'✅ 저장 완료':'❌ 저장 실패')
  .then(msg=>status.textContent=msg);
}
</script>

</body>
</html>
