<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Homepage Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: system-ui, sans-serif;
  background:#f5f6f8;
  margin:0;
  padding:20px;
}
.hidden { display:none; }
.box {
  background:#fff;
  border-radius:10px;
  padding:16px;
  margin-bottom:16px;
  border:1px solid #e5e7eb;
}
h1,h2,h3 { margin-top:0; }
button {
  padding:8px 14px;
  cursor:pointer;
}
button.primary {
  background:#111;
  color:#fff;
  border:none;
}
button.danger {
  background:#fee;
  border:1px solid #f99;
  color:#900;
}
input, textarea, select {
  width:100%;
  margin-top:4px;
  padding:6px;
  box-sizing:border-box;
}
textarea { font-family:monospace; }
.tabs button { margin-right:6px; }
.section-item {
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:12px;
  margin-bottom:12px;
}
.row {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
pre { font-size:13px; }
.footer-save {
  position:sticky;
  bottom:0;
  background:#f5f6f8;
  padding-top:12px;
}
.badge {
  font-size:12px;
  padding:2px 6px;
  border-radius:6px;
  background:#111;
  color:#fff;
}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginBox" class="box">
  <h2>Admin Login</h2>
  <label>ID
    <input id="loginId" />
  </label>
  <label>Password
    <input id="loginPw" type="password" />
  </label>
  <br>
  <button class="primary" onclick="login()">로그인</button>
  <pre id="loginStatus"></pre>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminBox" class="hidden">

<h1>Homepage Admin</h1>

<div class="tabs">
  <button onclick="showTab('content')">콘텐츠</button>
  <button onclick="showTab('json')">JSON</button>
  <button onclick="showTab('design')">디자인</button>
  <button onclick="logout()">로그아웃</button>
</div>

<hr/>

<div id="contentTab"></div>
<div id="jsonTab" class="hidden"></div>
<div id="designTab" class="hidden"></div>

<pre id="status"></pre>
</div>

<script>
/* ================= ENV ================= */
const API = 'https://young-sunset-d631.koolee1372.workers.dev';
let TOKEN = localStorage.getItem('ADMIN_TOKEN');

let PAGE_DATA = null;
let DESIGN_TOKENS = null;
let DESIGN_META = null;

/* ================= INIT ================= */
if (TOKEN) initAdmin();
else showLogin();

function showLogin() {
  loginBox.classList.remove('hidden');
}
function initAdmin() {
  loginBox.classList.add('hidden');
  adminBox.classList.remove('hidden');
  loadAll();
}

/* ================= AUTH ================= */
function login() {
  fetch(API + '/api/admin/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      id: loginId.value,
      password: loginPw.value
    })
  })
  .then(r => r.ok ? r.json() : Promise.reject())
  .then(res => {
    TOKEN = res.token;
    localStorage.setItem('ADMIN_TOKEN', TOKEN);
    initAdmin();
  })
  .catch(() => loginStatus.textContent='❌ 로그인 실패');
}
function logout() {
  localStorage.removeItem('ADMIN_TOKEN');
  location.reload();
}

/* ================= LOAD ================= */
function loadAll() {
  Promise.all([
    fetch(API + '/api/content').then(r=>r.json()),
    fetch(API + '/api/design/tokens').then(r=>r.json()),
    fetch(API + '/api/design/versions').then(r=>r.json())
  ]).then(([c,t,m])=>{
    PAGE_DATA=c;
    DESIGN_TOKENS=t;
    DESIGN_META=m;
    renderContent();
    renderJSON();
    renderDesign();
  });
}

/* ================= TABS ================= */
function showTab(tab) {
  ['contentTab','jsonTab','designTab']
    .forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById(tab+'Tab').classList.remove('hidden');
}

/* ================= CONTENT ================= */
function renderContent() {
  contentTab.innerHTML = `
    <h2>콘텐츠 관리</h2>

    ${PAGE_DATA.sections.map((s,i)=>`
      <div class="section-item">
        <strong>${s.type.toUpperCase()}</strong>

        <label>
          활성
          <input type="checkbox" ${s.enabled?'checked':''}
            onchange="toggle(${i},this.checked)">
        </label>

        <label>제목
          <input value="${s.content?.title||''}"
            oninput="updateTitle(${i},this.value)">
        </label>

        ${s.content?.subtitle !== undefined ? `
        <label>부제목
          <input value="${s.content.subtitle||''}"
            oninput="updateSubtitle(${i},this.value)">
        </label>` : ''}

        <div class="row">
          <button onclick="move(${i},-1)">▲</button>
          <button onclick="move(${i},1)">▼</button>
          <button class="danger" onclick="removeSection(${i})">삭제</button>
        </div>
      </div>
    `).join('')}

    <button onclick="addSection()">+ 섹션 추가</button>

    <div class="footer-save">
      <button class="primary" onclick="saveContent()">저장하기</button>
    </div>
  `;
}

function preview() {
  window.postMessage({ type:'PREVIEW', data:PAGE_DATA }, '*');
}

function toggle(i,v){ PAGE_DATA.sections[i].enabled=v; preview(); }
function updateTitle(i,v){ PAGE_DATA.sections[i].content.title=v; preview(); }
function updateSubtitle(i,v){ PAGE_DATA.sections[i].content.subtitle=v; preview(); }

function move(i,d){
  const t=i+d;
  if(t<0||t>=PAGE_DATA.sections.length) return;
  [PAGE_DATA.sections[i],PAGE_DATA.sections[t]] =
    [PAGE_DATA.sections[t],PAGE_DATA.sections[i]];
  PAGE_DATA.sections.forEach((s,idx)=>s.order=idx+1);
  renderContent(); preview();
}

function removeSection(i){
  if(!confirm('이 섹션을 삭제하시겠습니까?'))return;
  PAGE_DATA.sections.splice(i,1);
  PAGE_DATA.sections.forEach((s,idx)=>s.order=idx+1);
  renderContent(); preview();
}

function addSection(){
  const type = prompt('섹션 타입 (hero, cards, list, cta, faq, pricing)');
  if(!type) return;
  PAGE_DATA.sections.push({
    id:'section-'+Date.now(),
    type,
    enabled:true,
    order:PAGE_DATA.sections.length+1,
    content:{ title:'새 섹션' },
    options:{},
    media:{ ratio:'16-9' }
  });
  renderContent(); preview();
}

/* ================= SAVE CONTENT ================= */
function saveContent(){
  if(!confirm('콘텐츠를 저장하시겠습니까?')) return;

  status.textContent = '저장 중입니다...';

  fetch(API+'/api/content',{
    method:'POST',
    headers:{
      'Authorization':'Bearer '+TOKEN,
      'Content-Type':'application/json'
    },
    body:JSON.stringify(PAGE_DATA)
  })
  .then(r=>r.ok?'✅ 저장되었습니다':'❌ 저장 실패')
  .then(msg=>status.textContent=msg);
}

/* ================= JSON ================= */
function renderJSON() {
  jsonTab.innerHTML = `
    <h2>Content JSON</h2>
    <textarea id="jsonEditor" rows="22">
${JSON.stringify(PAGE_DATA,null,2)}
    </textarea>
    <button onclick="applyJSON()">JSON 적용</button>
  `;
}

function applyJSON(){
  try{
    PAGE_DATA = JSON.parse(jsonEditor.value);
    renderContent(); preview();
  }catch{
    alert('JSON 오류');
  }
}

/* ================= DESIGN ================= */
function renderDesign() {
  designTab.innerHTML = `
    <h2>디자인 토큰</h2>
    <textarea id="designEditor" rows="20">
${JSON.stringify(DESIGN_TOKENS,null,2)}
    </textarea>
    <button class="primary" onclick="saveDesign()">디자인 저장</button>

    <hr/>
    <h3>버전</h3>
    ${(DESIGN_META.versions||[]).map(v=>`
      <div>
        <strong>${v.id}</strong>
        ${v.id===DESIGN_META.current ? '<span class="badge">현재</span>' : ''}
        (${v.createdAt})
        ${v.id!==DESIGN_META.current ? `
          <button onclick="rollback('${v.id}')">롤백</button>
          <button onclick="deleteVersion('${v.id}')">삭제</button>
        ` : ''}
      </div>
    `).join('')}
  `;
}

function saveDesign(){
  if(!confirm('디자인을 저장하시겠습니까?')) return;
  fetch(API+'/api/design/tokens',{
    method:'POST',
    headers:{
      'Authorization':'Bearer '+TOKEN,
      'Content-Type':'application/json'
    },
    body:JSON.stringify(JSON.parse(designEditor.value))
  }).then(()=>loadAll());
}

function rollback(id){
  if(!confirm(id+'로 롤백할까요?')) return;
  fetch(API+'/api/design/rollback/'+id,{
    method:'POST',
    headers:{'Authorization':'Bearer '+TOKEN}
  }).then(()=>loadAll());
}

function deleteVersion(id){
  if(!confirm('이 버전을 삭제할까요?')) return;
  fetch(API+'/api/design/delete/'+id,{
    method:'POST',
    headers:{'Authorization':'Bearer '+TOKEN}
  }).then(()=>loadAll());
}
</script>

</body>
</html>
