<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Homepage Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: system-ui, sans-serif;
  background:#f5f6f8;
  margin:0;
  padding:20px;
}
.hidden { display:none; }
.box {
  background:#fff;
  border-radius:10px;
  padding:16px;
  margin-bottom:16px;
  border:1px solid #e5e7eb;
}
.section-item {
  border:1px dashed #d1d5db;
  border-radius:8px;
  padding:12px;
  margin-bottom:12px;
}
h1,h2,h3,h4 { margin-top:0; }
button {
  padding:8px 14px;
  cursor:pointer;
}
button.primary {
  background:#111;
  color:#fff;
  border:none;
}
button.danger {
  background:#fee;
  border:1px solid #f99;
  color:#900;
}
input, textarea, select {
  width:100%;
  margin-top:4px;
  padding:6px;
  box-sizing:border-box;
}
textarea { font-family:monospace; }
.row {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.subbox {
  border:1px dashed #ddd;
  padding:10px;
  margin-top:8px;
  border-radius:6px;
}
.footer-save {
  position:sticky;
  bottom:0;
  background:#f5f6f8;
  padding-top:12px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="box">
  <h2>Admin Login</h2>
  <label>ID
    <input id="loginId" />
  </label>
  <label>Password
    <input id="loginPw" type="password" />
  </label>
  <br>
  <button class="primary" onclick="login()">로그인</button>
  <pre id="loginStatus"></pre>
</div>

<!-- ADMIN -->
<div id="adminBox" class="hidden">
<h1>Homepage Admin</h1>

<div class="tabs">
  <button onclick="showTab('content')">콘텐츠</button>
  <button onclick="showTab('json')">JSON</button>
  <button onclick="showTab('design')">디자인</button>
  <button onclick="logout()">로그아웃</button>
</div>

<hr/>

<div id="contentTab"></div>
<div id="jsonTab" class="hidden"></div>
<div id="designTab" class="hidden"></div>

<pre id="status"></pre>
</div>

<script>
const API = 'https://young-sunset-d631.koolee1372.workers.dev';
let TOKEN = localStorage.getItem('ADMIN_TOKEN');
let PAGE_DATA = null;
let DESIGN_TOKENS = null;
let DESIGN_META = null;

/* ================= INIT ================= */
if (TOKEN) initAdmin();
else showLogin();

function showLogin(){ loginBox.classList.remove('hidden'); }
function initAdmin(){
  loginBox.classList.add('hidden');
  adminBox.classList.remove('hidden');
  loadAll();
}

/* ================= AUTH ================= */
function login(){
  fetch(API+'/api/admin/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ id:loginId.value, password:loginPw.value })
  })
  .then(r=>r.ok?r.json():Promise.reject())
  .then(res=>{
    TOKEN=res.token;
    localStorage.setItem('ADMIN_TOKEN',TOKEN);
    initAdmin();
  })
  .catch(()=>loginStatus.textContent='❌ 로그인 실패');
}
function logout(){
  localStorage.removeItem('ADMIN_TOKEN');
  location.reload();
}
/* ================= LOAD ================= */
function loadAll(){
  Promise.all([
    fetch(API+'/api/content').then(r=>r.json()),
    fetch(API+'/api/design/tokens').then(r=>r.json()),
    fetch(API+'/api/design/versions').then(r=>r.json())
  ]).then(([c,t,m])=>{
    PAGE_DATA=c;
    DESIGN_TOKENS=t;
    DESIGN_META=m;
    renderContent();
    renderJSON();
    renderDesign();
  });
}

/* ================= TABS ================= */
function showTab(tab){
  ['contentTab','jsonTab']
    .forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById(tab+'Tab').classList.remove('hidden');
}

/* ================= PREVIEW ================= */
function preview(){
  window.postMessage({ type:'PREVIEW', data:PAGE_DATA },'*');
}

/* ================= SCHEMA ================= */
function createSection(type){
  const base = {
    id:'section-'+Date.now(),
    type,
    enabled:true,
    order:PAGE_DATA.sections.length+1,
    media:{ ratio:'16-9', url:'' },
    options:{},
    content:{}
  };
  switch(type){
    case 'hero':
      base.content={ title:'', subtitle:'' };
      break;
    case 'cards':
      base.content={ title:'', items:[] };
      break;
    case 'list':
      base.content={ title:'', items:[] };
      break;
    case 'faq':
      base.content={ title:'', items:[] };
      break;
    case 'pricing':
      base.content={ title:'', items:[] };
      break;
    case 'cta':
      base.content={ title:'', button:{label:'',action:''} };
      break;
  }
  return base;
}

/* ================= CONTENT ================= */
function renderContent(){
  contentTab.innerHTML = `
    <h2>콘텐츠 관리</h2>

    ${PAGE_DATA.sections.map((s,i)=>renderSection(s,i)).join('')}

    <label>새 섹션 타입</label>
    <select id="newType">
      <option value="hero">hero</option>
      <option value="cards">cards</option>
      <option value="list">list</option>
      <option value="faq">faq</option>
      <option value="pricing">pricing</option>
      <option value="cta">cta</option>
    </select>
    <button onclick="addSection()">+ 섹션 추가</button>

    <div class="footer-save">
      <button class="primary" onclick="save()">저장하기</button>
    </div>
  `;
}

function renderSection(s,i){
  return `
  <div class="section-item">
    <h3>${s.type.toUpperCase()}</h3>

    <label>타입 변경
      <select onchange="changeType(${i},this.value)">
        ${['hero','cards','list','faq','pricing','cta']
          .map(t=>`<option value="${t}" ${s.type===t?'selected':''}>${t}</option>`).join('')}
      </select>
    </label>

    <label>
      활성
      <input type="checkbox" ${s.enabled?'checked':''}
        onchange="setEnabled(${i},this.checked)">
    </label>

    ${renderTypeUI(s,i)}

    <div class="row">
      <button onclick="move(${i},-1)">▲</button>
      <button onclick="move(${i},1)">▼</button>
      <button class="danger" onclick="removeSection(${i})">삭제</button>
    </div>
  </div>`;
}

/* ================= TYPE UI ================= */
function renderTypeUI(s,i){
  switch(s.type){
    case 'hero':
      return `
        <label>제목 <input value="${s.content.title}" oninput="setContent(${i},'title',this.value)"></label>
        <label>부제목 <input value="${s.content.subtitle}" oninput="setContent(${i},'subtitle',this.value)"></label>
        ${mediaUI(i)}
      `;
    case 'cta':
      return `
        <label>문구 <input value="${s.content.title}" oninput="setContent(${i},'title',this.value)"></label>
        <label>버튼 텍스트 <input value="${s.content.button.label}" oninput="setCTA(${i},'label',this.value)"></label>
        <label>버튼 링크 <input value="${s.content.button.action}" oninput="setCTA(${i},'action',this.value)"></label>
      `;
    case 'list':
    case 'faq':
      return `
        <label>항목 (줄바꿈)</label>
        <textarea oninput="setList(${i},this.value)">${s.content.items.map(it=>s.type==='faq'?it.q:it).join('\n')}</textarea>
      `;
    case 'pricing':
      return `
        ${s.content.items.map((p,pi)=>`
          <div class="subbox">
            <input placeholder="이름" value="${p.name||''}" oninput="setPrice(${i},${pi},'name',this.value)">
            <input placeholder="가격" value="${p.price||''}" oninput="setPrice(${i},${pi},'price',this.value)">
            <input placeholder="설명" value="${p.desc||''}" oninput="setPrice(${i},${pi},'desc',this.value)">
            <button onclick="removeItem(${i},${pi})">삭제</button>
          </div>`).join('')}
        <button onclick="addPrice(${i})">+ 요금제 추가</button>
      `;
    case 'cards':
      s.options = s.options||{};
      s.options.layout = s.options.layout||'grid';
      s.options.slider = s.options.slider||{autoplay:false,interval:4000};
      s.content.items = s.content.items||[];

      return `
        <label>레이아웃
          <select onchange="s.options.layout=this.value;renderContent();preview()">
            <option value="grid" ${s.options.layout==='grid'?'selected':''}>Grid</option>
            <option value="slider" ${s.options.layout==='slider'?'selected':''}>Slider</option>
          </select>
        </label>
        <label>미디어 URL (임시)
          <input
            placeholder="https://example.com/image.jpg"
            value="${s.media?.url || ''}"
            oninput="updateMediaURL(${i}, this.value)"
          >
        </label>
        ${s.options.layout==='slider' ? `
          <label>
            자동 재생
            <input type="checkbox" ${s.options.slider.autoplay?'checked':''}
              onchange="s.options.slider.autoplay=this.checked;preview()">
          </label>
          <label>간격(ms)
            <input type="number" value="${s.options.slider.interval}"
              onchange="s.options.slider.interval=Number(this.value);preview()">
          </label>
        `:''}

        <h4>카드</h4>
        ${s.content.items.map((c,ci)=>`
          <div class="subbox">
            <input placeholder="제목" value="${c.title||''}"
              oninput="c.title=this.value;preview()">
            <input placeholder="설명" value="${c.desc||''}"
              oninput="c.desc=this.value;preview()">
            <button onclick="removeItem(${i},${ci})">삭제</button>
          </div>
        `).join('')}
        <button onclick="addItem(${i},{title:'',desc:''})">+ 카드 추가</button>
      `;
  }
  return '';
}

function mediaUI(i){
  const m=PAGE_DATA.sections[i].media;
  return `
    <label>미디어 비율
      <select onchange="setMedia(${i},'ratio',this.value)">
        ${['16-9','4-3','1-1'].map(r=>`<option ${m.ratio===r?'selected':''}>${r}</option>`).join('')}
      </select>
    </label>
    <label>미디어 URL
      <input value="${m.url||''}" oninput="setMedia(${i},'url',this.value)">
    </label>`;
}

/* ================= ITEM HELPERS ================= */
function addItem(si,obj){
  PAGE_DATA.sections[si].content.items.push(obj);
  renderContent(); preview();
}
function removeItem(si,ii){
  PAGE_DATA.sections[si].content.items.splice(ii,1);
  renderContent(); preview();
}

/* ================= SECTION HELPERS ================= */
function move(i,d){
  const t=i+d;
  if(t<0||t>=PAGE_DATA.sections.length)return;
  [PAGE_DATA.sections[i],PAGE_DATA.sections[t]]=
    [PAGE_DATA.sections[t],PAGE_DATA.sections[i]];
  PAGE_DATA.sections.forEach((s,idx)=>s.order=idx+1);
  renderContent(); preview();
}
function removeSection(i){
  if(!confirm('이 섹션을 삭제할까요?'))return;
  PAGE_DATA.sections.splice(i,1);
  PAGE_DATA.sections.forEach((s,idx)=>s.order=idx+1);
  renderContent(); preview();
}
function addSection(){
  const type=prompt('섹션 타입 (hero,cards,list,faq,pricing,cta)');
  if(!type)return;
  PAGE_DATA.sections.push({
    id:'section-'+Date.now(),
    type,
    enabled:true,
    order:PAGE_DATA.sections.length+1,
    content:{title:'새 섹션',items:[]},
    options:{},
    media:{ratio:'16-9'}
  });
  renderContent(); preview();
}

/* ================= MUTATIONS ================= */
function setEnabled(i,v){ PAGE_DATA.sections[i].enabled=v; preview(); }
function setContent(i,k,v){ PAGE_DATA.sections[i].content[k]=v; preview(); }
function setCTA(i,k,v){ PAGE_DATA.sections[i].content.button[k]=v; preview(); }
function setMedia(i,k,v){ PAGE_DATA.sections[i].media[k]=v; preview(); }

function setList(i,v){
  const s=PAGE_DATA.sections[i];
  s.content.items=v.split('\n').filter(Boolean)
    .map(t=>s.type==='faq'?{q:t,a:''}:t);
  preview();
}

function setPrice(i,pi,k,v){ PAGE_DATA.sections[i].content.items[pi][k]=v; preview(); }
function setCard(i,ci,k,v){ PAGE_DATA.sections[i].content.items[ci][k]=v; preview(); }

function addPrice(i){ PAGE_DATA.sections[i].content.items.push({name:'',price:'',desc:''}); renderContent(); }
function addCard(i){ PAGE_DATA.sections[i].content.items.push({title:'',desc:''}); renderContent(); }
function removeItem(i,ii){ PAGE_DATA.sections[i].content.items.splice(ii,1); renderContent(); }

function changeType(i,type){
  PAGE_DATA.sections[i]=createSection(type);
  renderContent(); preview();
}
function move(i,d){
  const t=i+d;
  if(t<0||t>=PAGE_DATA.sections.length)return;
  [PAGE_DATA.sections[i],PAGE_DATA.sections[t]]=[PAGE_DATA.sections[t],PAGE_DATA.sections[i]];
  renderContent(); preview();
}
function removeSection(i){
  if(!confirm('삭제할까요?'))return;
  PAGE_DATA.sections.splice(i,1);
  renderContent(); preview();
}
function addSection(){
  const type=document.getElementById('newType').value;
  PAGE_DATA.sections.push(createSection(type));
  renderContent(); preview();
}

/* ================= SAVE / JSON ================= */
function save(){
  if(!confirm('저장하시겠습니까?'))return;
  fetch(API+'/api/content',{
    method:'POST',
    headers:{
      'Authorization':'Bearer '+TOKEN,
      'Content-Type':'application/json'
    },
    body:JSON.stringify(PAGE_DATA)
  }).then(()=>status.textContent='✅ 저장 완료');
}
function renderJSON(){
  jsonTab.innerHTML=`
    <h2>JSON</h2>
    <textarea rows="22" id="jsonEditor">${JSON.stringify(PAGE_DATA,null,2)}</textarea>
    <button onclick="applyJSON()">적용</button>
  `;
}
function applyJSON(){
  try{
    PAGE_DATA=JSON.parse(jsonEditor.value);
    renderContent(); preview();
  }catch{ alert('JSON 오류'); }
}

/* ================= DESIGN ================= */
function renderDesign(){
  designTab.innerHTML=`
    <h2>디자인 토큰</h2>
    <textarea rows="20" id="designEditor">
${JSON.stringify(DESIGN_TOKENS,null,2)}
    </textarea>
    <button class="primary" onclick="saveDesign()">디자인 저장</button>
  `;
}
function saveDesign(){
  fetch(API+'/api/design/tokens',{
    method:'POST',
    headers:{
      'Authorization':'Bearer '+TOKEN,
      'Content-Type':'application/json'
    },
    body:JSON.stringify(JSON.parse(designEditor.value))
  }).then(()=>loadAll());
}

/* ================= PREVIEW ================= */
function preview(){
  window.postMessage({type:'PREVIEW',data:PAGE_DATA},'*');
}
</script>

</body>
</html>
