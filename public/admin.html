<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Homepage Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f6f8;
      margin: 0;
      padding: 24px;
    }
    h1, h2, h3 { margin-top: 0; }

    .hidden { display: none; }

    .box {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
    button.primary {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    input, textarea, select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      margin-top: 4px;
    }
    textarea {
      height: 260px;
      font-family: monospace;
    }

    /* Section list */
    .section-list { display: flex; flex-direction: column; gap: 10px; }
    .section-item {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      display: grid;
      grid-template-columns: 28px 1fr auto;
      gap: 12px;
      align-items: center;
    }
    .drag-handle {
      cursor: grab;
      color: #9ca3af;
      font-size: 18px;
    }
    .section-meta { display: grid; gap: 6px; }
    .section-actions { display: flex; gap: 6px; }
    .section-item.dragging { opacity: 0.6; }
    .section-item.over { outline: 2px dashed #c7d2fe; }

    #status {
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<!-- ===============================
     LOGIN
================================ -->
<div id="loginBox" class="box">
  <h2>Admin Login</h2>
  <label>ID
    <input id="loginId" />
  </label>
  <label>Password
    <input id="loginPw" type="password" />
  </label>
  <br/>
  <button class="primary" onclick="login()">로그인</button>
  <pre id="loginStatus"></pre>
</div>

<!-- ===============================
     ADMIN
================================ -->
<div id="adminBox" class="hidden">

  <h1>Homepage Admin</h1>

  <div class="row">
    <button onclick="showTab('content')">콘텐츠</button>
    <button onclick="showTab('design')">디자인</button>
    <button onclick="showTab('raw')">JSON</button>
    <button class="primary" onclick="save()">저장</button>
    <button onclick="logout()">로그아웃</button>
  </div>

  <hr/>

  <!-- Tabs -->
  <div id="contentTab"></div>
  <div id="designTab" class="hidden"></div>
  <div id="rawTab" class="hidden"></div>

  <pre id="status"></pre>
</div>

<script>
/* ===============================
   ENV
================================ */
const API = 'https://young-sunset-d631.koolee1372.workers.dev';
let TOKEN = localStorage.getItem('ADMIN_TOKEN');
let contentData = null;
let currentTab = 'content';

/* ===============================
   INIT
================================ */
if (TOKEN) initAdmin();
else showLogin();

function showLogin() {
  loginBox.classList.remove('hidden');
}
function initAdmin() {
  loginBox.classList.add('hidden');
  adminBox.classList.remove('hidden');
  loadContent();
}

/* ===============================
   AUTH
================================ */
function login() {
  fetch(API + '/api/admin/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id: loginId.value,
      password: loginPw.value
    })
  })
  .then(r => r.ok ? r.json() : Promise.reject())
  .then(res => {
    TOKEN = res.token;
    localStorage.setItem('ADMIN_TOKEN', TOKEN);
    initAdmin();
  })
  .catch(() => loginStatus.textContent = '❌ 로그인 실패');
}

function logout() {
  localStorage.removeItem('ADMIN_TOKEN');
  location.reload();
}

/* ===============================
   TABS
================================ */
function showTab(tab) {
  currentTab = tab;
  ['contentTab','designTab','rawTab']
    .forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById(tab + 'Tab').classList.remove('hidden');

  if (tab === 'design') loadDesign();
  if (tab === 'raw') renderRaw();
}

/* ===============================
   CONTENT
================================ */
function loadContent() {
  fetch(API + '/api/content')
    .then(r => r.json())
    .then(data => {
      contentData = data;
      renderSectionList();
    });
}

function renderSectionList() {
  contentTab.innerHTML = `
    <h3>섹션 관리</h3>
    <div class="row">
      <button onclick="addSection()">+ 섹션 추가</button>
      <button onclick="preview()">미리보기</button>
    </div>
    <div id="sectionList" class="section-list"></div>
  `;
  const list = document.getElementById('sectionList');

  list.innerHTML = contentData.sections
    .sort((a,b)=>a.order-b.order)
    .map((s,i)=>`
      <div class="section-item"
        draggable="true"
        data-index="${i}"
        ondragstart="onDragStart(event)"
        ondragover="onDragOver(event)"
        ondragleave="onDragLeave(event)"
        ondrop="onDrop(event)"
        ondragend="onDragEnd(event)">

        <div class="drag-handle">⋮⋮</div>

        <div class="section-meta">
          <strong>${s.type.toUpperCase()}</strong>
          <small>${s.id}</small>

          <label>
            활성
            <input type="checkbox" ${s.enabled?'checked':''}
              onchange="contentData.sections[${i}].enabled=this.checked; preview();">
          </label>

          <label>제목
            <input value="${s.content?.title||''}"
              onchange="contentData.sections[${i}].content.title=this.value; preview();">
          </label>
        </div>

        <div class="section-actions">
          <button onclick="moveSection(${i},-1)">▲</button>
          <button onclick="moveSection(${i},1)">▼</button>
          <button onclick="removeSection(${i})">삭제</button>
        </div>
      </div>
    `).join('');
}

/* ===============================
   Section Ops
================================ */
function addSection() {
  const type = prompt('섹션 타입 (hero / cards / list / cta / gallery / faq / pricing)');
  if (!type) return;

  const base = {
    id: type + '-' + Date.now(),
    type,
    enabled: true,
    order: contentData.sections.length + 1,
    content: { title: '', subtitle: '', items: [] },
    media: { type: 'image', ratio: '16-9', position: 'top' },
    options: {}
  };

  if (type === 'cards') base.content.items = [{ title:'카드', desc:'설명' }];
  if (type === 'list') base.content.items = ['항목'];

  contentData.sections.push(base);
  renderSectionList();
  preview();
}

function moveSection(i, d) {
  const j = i + d;
  if (j < 0 || j >= contentData.sections.length) return;
  [contentData.sections[i], contentData.sections[j]] =
    [contentData.sections[j], contentData.sections[i]];
  contentData.sections.forEach((s,idx)=>s.order=idx+1);
  renderSectionList();
  preview();
}

function removeSection(i) {
  if (!confirm('섹션을 삭제할까요?')) return;
  contentData.sections.splice(i,1);
  contentData.sections.forEach((s,idx)=>s.order=idx+1);
  renderSectionList();
  preview();
}

/* ===============================
   Drag & Drop
================================ */
let dragFrom = null;

function onDragStart(e) {
  dragFrom = Number(e.currentTarget.dataset.index);
  e.currentTarget.classList.add('dragging');
}
function onDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('over');
}
function onDragLeave(e) {
  e.currentTarget.classList.remove('over');
}
function onDrop(e) {
  e.preventDefault();
  const to = Number(e.currentTarget.dataset.index);
  if (dragFrom === to) return;

  const moved = contentData.sections.splice(dragFrom,1)[0];
  contentData.sections.splice(to,0,moved);
  contentData.sections.forEach((s,idx)=>s.order=idx+1);

  renderSectionList();
  preview();
}
function onDragEnd(e) {
  document.querySelectorAll('.section-item')
    .forEach(el=>el.classList.remove('dragging','over'));
}

/* ===============================
   PREVIEW
================================ */
function preview() {
  window.open('/', 'preview');
}

/* ===============================
   RAW JSON
================================ */
function renderRaw() {
  rawTab.innerHTML = `
    <h3>Raw JSON</h3>
    <textarea id="rawEditor">${JSON.stringify(contentData, null, 2)}</textarea>
  `;
}

/* ===============================
   DESIGN (Tokens only – UI placeholder)
================================ */
function loadDesign() {
  designTab.innerHTML = `
    <h3>디자인 토큰</h3>
    <p>디자인 토큰 편집 UI는 다음 단계에서 고도화됩니다.</p>
  `;
}

/* ===============================
   SAVE
================================ */
function save() {
  if (currentTab === 'raw') {
    try {
      contentData = JSON.parse(rawEditor.value);
    } catch {
      alert('JSON 오류');
      return;
    }
  }

  fetch(API + '/api/content', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer ' + TOKEN
    },
    body:JSON.stringify(contentData)
  })
  .then(r=>r.ok?'✅ 저장 완료':'❌ 저장 실패')
  .then(msg=>status.textContent=msg);
}
</script>

</body>
</html>
